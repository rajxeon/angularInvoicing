"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var MetadataEntry_1 = require("./MetadataEntry");
/**
 * A NgxDOMComponent represent a angular component in the DOM.
 * It allows simple creation, deletion, and moves in the DOM of the element.
 */
var NgxDOMComponent = /** @class */ (function () {
    function NgxDOMComponent(options) {
        options = NgxDOMComponent.normalizeNgxDOMComponentOptions(options);
        this._viewContainerRef = options.viewContainerRef;
        // create the angular component
        this._componentRef = this._viewContainerRef.createComponent(NgxDOMComponent.componentFactoryResolver.resolveComponentFactory(options.componentType), options.index);
        // extract the metadata of the component
        this._metadata = MetadataEntry_1.GetNgxEntryComponentMetaData(options.componentType);
        // create a differ for the instance
        this._differ = NgxDOMComponent.differs
            .find(this._componentRef.instance)
            .create();
        // bind inputs and outputs with the create component's instance
        var metadataEntry;
        for (var i = 0, l = this._metadata.length; i < l; i++) {
            metadataEntry = this._metadata[i];
            switch (metadataEntry.metadataName) {
                case 'Input':
                    if (options.inputs[metadataEntry.propertyName]) {
                        this._componentRef.instance[metadataEntry.propertyName] = options.inputs[metadataEntry.propertyName];
                    }
                    else {
                        console.warn("Missing input '" + metadataEntry.propertyName + "' for " + options.componentType);
                    }
                    break;
                case 'Output':
                    if (typeof options.outputs[metadataEntry.propertyName] === 'function') {
                        this._componentRef.instance[metadataEntry.propertyName].subscribe(options.outputs[metadataEntry.propertyName]);
                    }
                    else {
                        console.warn("Missing output '" + metadataEntry.propertyName + "' for " + options.componentType);
                    }
                    break;
            }
        }
        this.detectChanges();
    }
    NgxDOMComponent.normalizeNgxDOMComponentOptions = function (options) {
        if (typeof options.viewContainerRef !== 'object') {
            throw new Error("Invalid viewContainerRef");
        }
        if (typeof options.componentType !== 'function') {
            throw new Error("Invalid component");
        }
        if (typeof options.inputs !== 'object') {
            options.inputs = {};
        }
        if (typeof options.outputs !== 'object') {
            options.outputs = {};
        }
        if ((typeof options.index !== 'number') || Number.isNaN(options.index)) {
            options.index = void 0;
        }
        return options;
    };
    Object.defineProperty(NgxDOMComponent.prototype, "viewContainerRef", {
        /**
         * The angular view on the parent of the element
         * @return {ViewContainerRef}
         */
        get: /**
           * The angular view on the parent of the element
           * @return {ViewContainerRef}
           */
        function () {
            return this._viewContainerRef;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxDOMComponent.prototype, "componentRef", {
        /**
         * The angular component
         * @return {ComponentRef<any>}
         */
        get: /**
           * The angular component
           * @return {ComponentRef<any>}
           */
        function () {
            return this._componentRef;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxDOMComponent.prototype, "componentType", {
        /**
         * The constructor of the element
         * @return {ComponentRef<any>}
         */
        get: /**
           * The constructor of the element
           * @return {ComponentRef<any>}
           */
        function () {
            return this._componentRef.componentType;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxDOMComponent.prototype, "element", {
        /**
         * The actual DOM element.
         * @return {HTMLElement}
         */
        get: /**
           * The actual DOM element.
           * @return {HTMLElement}
           */
        function () {
            return this._componentRef.location.nativeElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxDOMComponent.prototype, "instance", {
        /**
         * The instance of the constructor
         * @return {any}
         */
        get: /**
           * The instance of the constructor
           * @return {any}
           */
        function () {
            return this._componentRef.instance;
        },
        enumerable: true,
        configurable: true
    });
    NgxDOMComponent.prototype.insert = function (index, viewContainerRef) {
        if (index === void 0) { index = null; }
        if (viewContainerRef === void 0) { viewContainerRef = this._viewContainerRef; }
        if (typeof index !== 'number') {
            index = this._viewContainerRef.length;
        }
        this._viewContainerRef = viewContainerRef;
        this._viewContainerRef.insert(this._componentRef.hostView, index);
        return this;
    };
    NgxDOMComponent.prototype.move = function (index, viewContainerRef) {
        if (index === void 0) { index = 0; }
        if (viewContainerRef === void 0) { viewContainerRef = this._viewContainerRef; }
        this._viewContainerRef = viewContainerRef;
        this._viewContainerRef.move(this._componentRef.hostView, index);
        return this;
    };
    NgxDOMComponent.prototype.detach = function () {
        this._viewContainerRef.detach(this._viewContainerRef.indexOf(this._componentRef.hostView));
        return this;
    };
    NgxDOMComponent.prototype.destroy = function () {
        this._viewContainerRef.remove(this._viewContainerRef.indexOf(this._componentRef.hostView));
        return this;
    };
    NgxDOMComponent.prototype.getChanges = function () {
        var _this = this;
        var changes = null;
        var diff = this._differ.diff(this._componentRef.instance);
        if (diff) {
            diff.forEachItem(function (change) {
                var metadataEntry;
                for (var i = 0, l = _this._metadata.length; i < l; i++) {
                    metadataEntry = _this._metadata[i];
                    if ((metadataEntry.propertyName === change.key) && (metadataEntry.metadataName === 'Input')) {
                        // check that metadata exists for this change
                        if (changes === null) {
                            changes = {};
                        }
                        changes[change.key] = new core_1.SimpleChange(change.previousValue, change.currentValue, false);
                        break;
                    }
                }
            });
        }
        return changes;
    };
    NgxDOMComponent.prototype.detectChanges = function () {
        if (typeof this._componentRef.instance.ngOnChanges === 'function') {
            var changes = this.getChanges();
            if (changes) {
                this._componentRef.instance.ngOnChanges(changes);
            }
        }
    };
    NgxDOMComponent.componentFactoryResolver = null;
    NgxDOMComponent.differs = null;
    return NgxDOMComponent;
}());
exports.NgxDOMComponent = NgxDOMComponent;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmd4RE9NQ29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsYXNzZXMvTmd4RE9NQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTZLO0FBQzdLLGlEQUE4RTs7Ozs7O0lBZ0Q1RSx5QkFBWSxPQUErQjtRQUN6QyxPQUFPLEdBQUcsZUFBZSxDQUFDLCtCQUErQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5FLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7O1FBR2xELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGVBQWUsQ0FDekQsZUFBZSxDQUFDLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFDdkYsT0FBTyxDQUFDLEtBQUssQ0FDZCxDQUFDOztRQUdGLElBQUksQ0FBQyxTQUFTLEdBQUcsNENBQTRCLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDOztRQUdyRSxJQUFJLENBQUMsT0FBTyxHQUFHLGVBQWUsQ0FBQyxPQUFPO2FBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQzthQUNqQyxNQUFNLEVBQUUsQ0FBQzs7UUFHWixJQUFJLGFBQTRCLENBQUM7UUFDakMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdEQsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFDLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQ25DLEtBQUssT0FBTztvQkFDVixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMs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Q0FBYSxHQUFiO1FBQ0UsRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNsRSxJQUFNLE9BQU8sR0FBa0IsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2pELEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ1osSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ2xEO1NBQ0Y7S0FDRjsrQ0FqTDJELElBQUk7OEJBQzlCLElBQUk7MEJBbEJ4Qzs7QUFnQmEsMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgS2V5VmFsdWVDaGFuZ2VSZWNvcmQsIEtleVZhbHVlRGlmZmVyLCBLZXlWYWx1ZURpZmZlcnMsIFNpbXBsZUNoYW5nZSwgU2ltcGxlQ2hhbmdlcywgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBHZXROZ3hFbnRyeUNvbXBvbmVudE1ldGFEYXRhLCBNZXRhZGF0YUVudHJ5IH0gZnJvbSAnLi9NZXRhZGF0YUVudHJ5JztcclxuXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE5neERPTUNvbXBvbmVudE9wdGlvbnMge1xyXG4gIHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmOyAvLyB0aGUgcGFyZW50IG9mIHRoZSBjb21wb25lbnRcclxuICBjb21wb25lbnRUeXBlOiBhbnk7IC8vIHRoZSBjb21wb25lbnQgY2xhc3NcclxuICBpbnB1dHM/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9OyAvLyBhIGxpc3Qgb2YgaW5wdXRzIHRvIHByb3ZpZGUgdG8gdGhlIGNvbXBvbmVudCBASW5wdXRcclxuICBvdXRwdXRzPzogeyBba2V5OiBzdHJpbmddOiBGdW5jdGlvbiB9OyAvLyBhIGxpc3Qgb2Ygb3V0cHV0IGNhbGxiYWNrcyB0byBwcm92aWRlIHRvIGxpbmsgd2l0aCB0aGUgY29tcG9uZW50IEBPdXRwdXRcclxuICBpbmRleD86IG51bWJlcjsgLy8gdGhlIHBvc2l0aW9uIHdoZXJlIHRvIGluamVjdCB5b3VyIGNvbXBvbmVudFxyXG59XHJcblxyXG4vKipcclxuICogQSBOZ3hET01Db21wb25lbnQgcmVwcmVzZW50IGEgYW5ndWxhciBjb21wb25lbnQgaW4gdGhlIERPTS5cclxuICogSXQgYWxsb3dzIHNpbXBsZSBjcmVhdGlvbiwgZGVsZXRpb24sIGFuZCBtb3ZlcyBpbiB0aGUgRE9NIG9mIHRoZSBlbGVtZW50LlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIE5neERPTUNvbXBvbmVudCB7XHJcbiAgc3RhdGljIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyID0gbnVsbDtcclxuICBzdGF0aWMgZGlmZmVyczogS2V5VmFsdWVEaWZmZXJzID0gbnVsbDtcclxuXHJcbiAgc3RhdGljIG5vcm1hbGl6ZU5neERPTUNvbXBvbmVudE9wdGlvbnMob3B0aW9uczogTmd4RE9NQ29tcG9uZW50T3B0aW9ucyk6IE5neERPTUNvbXBvbmVudE9wdGlvbnMge1xyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLnZpZXdDb250YWluZXJSZWYgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB2aWV3Q29udGFpbmVyUmVmYCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBvbmVudFR5cGUgIT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGNvbXBvbmVudGApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5pbnB1dHMgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgIG9wdGlvbnMuaW5wdXRzID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLm91dHB1dHMgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgIG9wdGlvbnMub3V0cHV0cyA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmICgodHlwZW9mIG9wdGlvbnMuaW5kZXggIT09ICdudW1iZXInKSB8fCBOdW1iZXIuaXNOYU4ob3B0aW9ucy5pbmRleCkpIHtcclxuICAgICAgb3B0aW9ucy5pbmRleCA9IHZvaWQgMDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gb3B0aW9ucztcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBfdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZjtcclxuICBwcm90ZWN0ZWQgX2NvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT47XHJcbiAgcHJvdGVjdGVkIF9tZXRhZGF0YTogTWV0YWRhdGFFbnRyeVtdO1xyXG4gIHByb3RlY3RlZCBfZGlmZmVyOiBLZXlWYWx1ZURpZmZlcjxzdHJpbmcsIGFueT47XHJcblxyXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE5neERPTUNvbXBvbmVudE9wdGlvbnMpIHtcclxuICAgIG9wdGlvbnMgPSBOZ3hET01Db21wb25lbnQubm9ybWFsaXplTmd4RE9NQ29tcG9uZW50T3B0aW9ucyhvcHRpb25zKTtcclxuXHJcbiAgICB0aGlzLl92aWV3Q29udGFpbmVyUmVmID0gb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmO1xyXG5cclxuICAgIC8vIGNyZWF0ZSB0aGUgYW5ndWxhciBjb21wb25lbnRcclxuICAgIHRoaXMuX2NvbXBvbmVudFJlZiA9IHRoaXMuX3ZpZXdDb250YWluZXJSZWYuY3JlYXRlQ29tcG9uZW50KFxyXG4gICAgICBOZ3hET01Db21wb25lbnQuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KG9wdGlvbnMuY29tcG9uZW50VHlwZSksXHJcbiAgICAgIG9wdGlvbnMuaW5kZXhcclxuICAgICk7XHJcblxyXG4gICAgLy8gZXh0cmFjdCB0aGUgbWV0YWRhdGEgb2YgdGhlIGNvbXBvbmVudFxyXG4gICAgdGhpcy5fbWV0YWRhdGEgPSBHZXROZ3hFbnRyeUNvbXBvbmVudE1ldGFEYXRhKG9wdGlvbnMuY29tcG9uZW50VHlwZSk7XHJcblxyXG4gICAgLy8gY3JlYXRlIGEgZGlmZmVyIGZvciB0aGUgaW5zdGFuY2VcclxuICAgIHRoaXMuX2RpZmZlciA9IE5neERPTUNvbXBvbmVudC5kaWZmZXJzXHJcbiAgICAgIC5maW5kKHRoaXMuX2NvbXBvbmVudFJlZi5pbnN0YW5jZSlcclxuICAgICAgLmNyZWF0ZSgpO1xyXG5cclxuICAgIC8vIGJpbmQgaW5wdXRzIGFuZCBvdXRwdXRzIHdpdGggdGhlIGNyZWF0ZSBjb21wb25lbnQncyBpbnN0YW5jZVxyXG4gICAgbGV0IG1ldGFkYXRhRW50cnk6IE1ldGFkYXRhRW50cnk7XHJcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMuX21ldGFkYXRhLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBtZXRhZGF0YUVudHJ5ID0gdGhpcy5fbWV0YWRhdGFbaV07XHJcbiAgICAgIHN3aXRjaCAobWV0YWRhdGFFbnRyeS5tZXRhZGF0YU5hbWUpIHtcclxuICAgICAgICBjYXNlICdJbnB1dCc6XHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5pbnB1dHNbbWV0YWRhdGFFbnRyeS5wcm9wZXJ0eU5hbWVdKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5pbnN0YW5jZVttZXRhZGF0YUVudHJ5LnByb3BlcnR5TmFtZV0gPSBvcHRpb25zLmlucHV0c1ttZXRhZGF0YUVudHJ5LnByb3BlcnR5TmFtZV07XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYE1pc3NpbmcgaW5wdXQgJyR7bWV0YWRhdGFFbnRyeS5wcm9wZXJ0eU5hbWV9JyBmb3IgJHtvcHRpb25zLmNvbXBvbmVudFR5cGV9YCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdPdXRwdXQnOlxyXG4gICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLm91dHB1dHNbbWV0YWRhdGFFbnRyeS5wcm9wZXJ0eU5hbWVdID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5pbnN0YW5jZVttZXRhZGF0YUVudHJ5LnByb3BlcnR5TmFtZV0uc3Vic2NyaWJlKG9wdGlvbnMub3V0cHV0c1ttZXRhZGF0YUVudHJ5LnByb3BlcnR5TmFtZV0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGBNaXNzaW5nIG91dHB1dCAnJHttZXRhZGF0YUVudHJ5LnByb3BlcnR5TmFtZX0nIGZvciAke29wdGlvbnMuY29tcG9uZW50VHlwZX1gKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGFuZ3VsYXIgdmlldyBvbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50XHJcbiAgICogQHJldHVybiB7Vmlld0NvbnRhaW5lclJlZn1cclxuICAgKi9cclxuICBnZXQgdmlld0NvbnRhaW5lclJlZigpOiBWaWV3Q29udGFpbmVyUmVmIHtcclxuICAgIHJldHVybiB0aGlzLl92aWV3Q29udGFpbmVyUmVmO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGFuZ3VsYXIgY29tcG9uZW50XHJcbiAgICogQHJldHVybiB7Q29tcG9uZW50UmVmPGFueT59XHJcbiAgICovXHJcbiAgZ2V0IGNvbXBvbmVudFJlZigpOiBDb21wb25lbnRSZWY8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29tcG9uZW50UmVmO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGNvbnN0cnVjdG9yIG9mIHRoZSBlbGVtZW50XHJcbiAgICogQHJldHVybiB7Q29tcG9uZW50UmVmPGFueT59XHJcbiAgICovXHJcbiAgZ2V0IGNvbXBvbmVudFR5cGUoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9jb21wb25lbnRSZWYuY29tcG9uZW50VHlwZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBhY3R1YWwgRE9NIGVsZW1lbnQuXHJcbiAgICogQHJldHVybiB7SFRNTEVsZW1lbnR9XHJcbiAgICovXHJcbiAgZ2V0IGVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGluc3RhbmNlIG9mIHRoZSBjb25zdHJ1Y3RvclxyXG4gICAqIEByZXR1cm4ge2FueX1cclxuICAgKi9cclxuICBnZXQgaW5zdGFuY2UoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgaW5zZXJ0KGluZGV4OiBudW1iZXIgPSBudWxsLCB2aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmID0gdGhpcy5fdmlld0NvbnRhaW5lclJlZik6IHRoaXMge1xyXG4gICAgaWYgKHR5cGVvZiBpbmRleCAhPT0gJ251bWJlcicpIHtcclxuICAgICAgaW5kZXggPSB0aGlzLl92aWV3Q29udGFpbmVyUmVmLmxlbmd0aDtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl92aWV3Q29udGFpbmVyUmVmID0gdmlld0NvbnRhaW5lclJlZjtcclxuICAgIHRoaXMuX3ZpZXdDb250YWluZXJSZWYuaW5zZXJ0KHRoaXMuX2NvbXBvbmVudFJlZi5ob3N0VmlldywgaW5kZXgpO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgbW92ZShpbmRleDogbnVtYmVyID0gMCwgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZiA9IHRoaXMuX3ZpZXdDb250YWluZXJSZWYpOiB0aGlzIHtcclxuICAgIHRoaXMuX3ZpZXdDb250YWluZXJSZWYgPSB2aWV3Q29udGFpbmVyUmVmO1xyXG4gICAgdGhpcy5fdmlld0NvbnRhaW5lclJlZi5tb3ZlKHRoaXMuX2NvbXBvbmVudFJlZi5ob3N0VmlldywgaW5kZXgpO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgZGV0YWNoKCk6IHRoaXMge1xyXG4gICAgdGhpcy5fdmlld0NvbnRhaW5lclJlZi5kZXRhY2godGhpcy5fdmlld0NvbnRhaW5lclJlZi5pbmRleE9mKHRoaXMuX2NvbXBvbmVudFJlZi5ob3N0VmlldykpO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgZGVzdHJveSgpOiB0aGlzIHtcclxuICAgIHRoaXMuX3ZpZXdDb250YWluZXJSZWYucmVtb3ZlKHRoaXMuX3ZpZXdDb250YWluZXJSZWYuaW5kZXhPZih0aGlzLl9jb21wb25lbnRSZWYuaG9zdFZpZXcpKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG5cclxuICBnZXRDaGFuZ2VzKCk6IFNpbXBsZUNoYW5nZXMgfCBudWxsIHtcclxuICAgIGxldCBjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzIHwgbnVsbCA9IG51bGw7XHJcbiAgICBjb25zdCBkaWZmID0gdGhpcy5fZGlmZmVyLmRpZmYodGhpcy5fY29tcG9uZW50UmVmLmluc3RhbmNlKTtcclxuICAgIGlmIChkaWZmKSB7XHJcbiAgICAgIGRpZmYuZm9yRWFjaEl0ZW0oKGNoYW5nZTogS2V5VmFsdWVDaGFuZ2VSZWNvcmQ8c3RyaW5nLCBhbnk+KSA9PiB7XHJcbiAgICAgICAgbGV0IG1ldGFkYXRhRW50cnk6IE1ldGFkYXRhRW50cnk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLl9tZXRhZGF0YS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgIG1ldGFkYXRhRW50cnkgPSB0aGlzLl9tZXRhZGF0YVtpXTtcclxuICAgICAgICAgIGlmICgobWV0YWRhdGFFbnRyeS5wcm9wZXJ0eU5hbWUgPT09IGNoYW5nZS5rZXkpICYmIChtZXRhZGF0YUVudHJ5Lm1ldGFkYXRhTmFtZSA9PT0gJ0lucHV0JykpIHsgLy8gY2hlY2sgdGhhdCBtZXRhZGF0YSBleGlzdHMgZm9yIHRoaXMgY2hhbmdlXHJcbiAgICAgICAgICAgIGlmIChjaGFuZ2VzID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgY2hhbmdlcyA9IHt9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNoYW5nZXNbY2hhbmdlLmtleV0gPSBuZXcgU2ltcGxlQ2hhbmdlKGNoYW5nZS5wcmV2aW91c1ZhbHVlLCBjaGFuZ2UuY3VycmVudFZhbHVlLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2hhbmdlcztcclxuICB9XHJcblxyXG4gIGRldGVjdENoYW5nZXMoKTogdm9pZCB7XHJcbiAgICBpZiAodHlwZW9mIHRoaXMuX2NvbXBvbmVudFJlZi5pbnN0YW5jZS5uZ09uQ2hhbmdlcyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBjb25zdCBjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzID0gdGhpcy5nZXRDaGFuZ2VzKCk7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgdGhpcy5fY29tcG9uZW50UmVmLmluc3RhbmNlLm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxufSJdfQ==