"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var ngx_dom_component_1 = require("ngx-dom-component");
var DeferredPromise_1 = require("../classes/DeferredPromise");
var NgxPopupState;
(function (NgxPopupState) {
    NgxPopupState["CLOSED"] = "closed";
    NgxPopupState["CLOSING"] = "closing";
    NgxPopupState["OPENED"] = "opened";
    NgxPopupState["OPENING"] = "opening";
})(NgxPopupState = exports.NgxPopupState || (exports.NgxPopupState = {}));
var NgxPopupComponent = /** @class */ (function () {
    function NgxPopupComponent(ngxDOMComponentService, element) {
        this.ngxDOMComponentService = ngxDOMComponentService;
        this._closableListener = null;
        this._backgroundClosable = true;
        this._openPromise = null;
        this._closePromise = null;
        this._state = NgxPopupState.CLOSED;
        this._element = element.nativeElement;
    }
    Object.defineProperty(NgxPopupComponent.prototype, "contentInstance", {
        /**
         * Returns the instance of the injected component.
         */
        get: /**
           * Returns the instance of the injected component.
           */
        function () {
            return this._ngxDOMComponent.instance;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxPopupComponent.prototype, "element", {
        /**
         * Returns the DOM element of the popup
         * @returns {HTMLElement}
         */
        get: /**
           * Returns the DOM element of the popup
           * @returns {HTMLElement}
           */
        function () {
            return this._element;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxPopupComponent.prototype, "state", {
        get: function () {
            return this._state;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxPopupComponent.prototype, "closable", {
        get: function () {
            return this._closableListener === null;
        },
        set: function (value) {
            var _this = this;
            value = Boolean(value);
            var closable = (this._closableListener === null);
            if (value !== closable) {
                if (closable) {
                    // switch from true to false
                    var listener_1 = function (event) {
                        event.preventDefault();
                    };
                    this.addEventListener('beforeclose', listener_1);
                    this._closableListener = function () {
                        _this.removeEventListener('beforeclose', listener_1);
                        _this._closableListener = null;
                    };
                }
                else {
                    // switch from false to true
                    this._closableListener();
                }
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxPopupComponent.prototype, "backgroundClosable", {
        get: function () {
            return this._backgroundClosable;
        },
        set: function (value) {
            this._backgroundClosable = Boolean(value);
        },
        enumerable: true,
        configurable: true
    });
    NgxPopupComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        this._ngxDOMComponentContainer = this.ngxDOMComponentService.createContainer(this.contentContainer);
        requestAnimationFrame(function () {
            // allows css to apply without the class 'open'
            _this.dispatchEvent(new CustomEvent('ready'));
        });
    };
    /**
     * The following events are available
     *
     * - open : after the popup is opened (including transition or not, according to 'waitTransitionEnd').
     * - close : after the popup is closed (including transition or not, according to 'waitTransitionEnd').
     * - beforeclose : when the close method is called. Use event.preventDefault() to cancel close.
     * - cancelopen : when an open is cancelled (ex: while animating, the popup is in a 'opening' state,
     *                if you call close before animation is complete, it cancels the open).
     *
     * All of them are CustomEvent, with a detail property that you can set when calling open or close.
     */
    /**
       * The following events are available
       *
       * - open : after the popup is opened (including transition or not, according to 'waitTransitionEnd').
       * - close : after the popup is closed (including transition or not, according to 'waitTransitionEnd').
       * - beforeclose : when the close method is called. Use event.preventDefault() to cancel close.
       * - cancelopen : when an open is cancelled (ex: while animating, the popup is in a 'opening' state,
       *                if you call close before animation is complete, it cancels the open).
       *
       * All of them are CustomEvent, with a detail property that you can set when calling open or close.
       */
    NgxPopupComponent.prototype.addEventListener = /**
       * The following events are available
       *
       * - open : after the popup is opened (including transition or not, according to 'waitTransitionEnd').
       * - close : after the popup is closed (including transition or not, according to 'waitTransitionEnd').
       * - beforeclose : when the close method is called. Use event.preventDefault() to cancel close.
       * - cancelopen : when an open is cancelled (ex: while animating, the popup is in a 'opening' state,
       *                if you call close before animation is complete, it cancels the open).
       *
       * All of them are CustomEvent, with a detail property that you can set when calling open or close.
       */
    function (type, listener, useCapture) {
        return this._element.addEventListener(type, listener, useCapture);
    };
    NgxPopupComponent.prototype.dispatchEvent = function (event) {
        return this._element.dispatchEvent(event);
    };
    NgxPopupComponent.prototype.removeEventListener = function (type, listener, useCapture) {
        return this._element.removeEventListener(type, listener, useCapture);
    };
    NgxPopupComponent.prototype.open = function (config, waitTransitionEnd, detail) {
        var _this = this;
        if (waitTransitionEnd === void 0) { waitTransitionEnd = true; }
        if (this._openPromise === null) {
            this._openPromise = new DeferredPromise_1.DeferredPromise(function () {
                switch (_this._state) {
                    case NgxPopupState.CLOSED:
                    case NgxPopupState.CLOSING:
                        var beforeOpenPrevented = !_this.dispatchEvent(new CustomEvent('beforeopen', {
                            detail: detail,
                            bubbles: false,
                            cancelable: true
                        }));
                        if (beforeOpenPrevented) {
                            _this._openPromise.reject(new Error("Open prevented"));
                        }
                        else {
                            if (_this._state === NgxPopupState.CLOSING) {
                                _this.dispatchEvent(new CustomEvent('cancelclose'));
                                _this._closePromise.reject(new Error("Close cancelled"));
                            }
                            _this._state = NgxPopupState.OPENING;
                            _this._build(config);
                            requestAnimationFrame(function () {
                                // allows content to be rendered before adding 'open'
                                _this._element.classList.add('open');
                                if (waitTransitionEnd) {
                                    _this._waitTransitionEnd().then(function () {
                                        if (_this._openPromise !== null) {
                                            _this._openPromise.resolve();
                                        }
                                    });
                                }
                                else {
                                    _this._openPromise.resolve();
                                }
                            });
                        }
                        break;
                    default:
                        _this._openPromise.reject(new Error("Popup not closed"));
                        break;
                }
            });
            this._openPromise
                .then(function () {
                _this._state = NgxPopupState.OPENED;
                _this._openPromise = null;
                _this.dispatchEvent(new CustomEvent('open', {
                    detail: detail
                }));
            }, function () {
                _this._openPromise = null;
            });
        }
        return this._openPromise.promise;
    };
    /**
     * Close the popup.
     *
     * @param waitTransitionEnd
     * @param detail
     * @returns {Promise<void>} - promise resolved when the popup is closed
     */
    /**
       * Close the popup.
       *
       * @param waitTransitionEnd
       * @param detail
       * @returns {Promise<void>} - promise resolved when the popup is closed
       */
    NgxPopupComponent.prototype.close = /**
       * Close the popup.
       *
       * @param waitTransitionEnd
       * @param detail
       * @returns {Promise<void>} - promise resolved when the popup is closed
       */
    function (waitTransitionEnd, detail) {
        var _this = this;
        if (waitTransitionEnd === void 0) { waitTransitionEnd = true; }
        if (this._closePromise === null) {
            this._closePromise = new DeferredPromise_1.DeferredPromise(function () {
                switch (_this._state) {
                    case NgxPopupState.OPENED:
                    case NgxPopupState.OPENING:
                        var beforeClosePrevented = !_this.dispatchEvent(new CustomEvent('beforeclose', {
                            detail: detail,
                            bubbles: false,
                            cancelable: true
                        }));
                        if (beforeClosePrevented) {
                            _this._closePromise.reject(new Error("Close prevented"));
                        }
                        else {
                            if (_this._state === NgxPopupState.OPENING) {
                                _this.dispatchEvent(new CustomEvent('cancelopen'));
                                _this._openPromise.reject(new Error("Open cancelled"));
                            }
                            _this._state = NgxPopupState.CLOSING;
                            _this._element.classList.remove('open');
                            if (waitTransitionEnd) {
                                _this._waitTransitionEnd().then(function () {
                                    if (_this._closePromise !== null) {
                                        _this._closePromise.resolve();
                                    }
                                });
                            }
                            else {
                                _this._closePromise.resolve();
                            }
                        }
                        break;
                    default:
                        _this._closePromise.reject(new Error("Popup not opened"));
                        break;
                }
            });
            this._closePromise
                .then(function () {
                _this._state = NgxPopupState.CLOSED;
                _this._closePromise = null;
                _this.dispatchEvent(new CustomEvent('close', {
                    detail: detail
                }));
            }, function () {
                _this._closePromise = null;
            });
        }
        return this._closePromise.promise;
    };
    NgxPopupComponent.prototype.onClickBackground = function (event) {
        if (this._backgroundClosable && (event.target === this._element)) {
            this.close(true, event);
        }
    };
    NgxPopupComponent.prototype._build = function (config) {
        config.inputs = config.inputs || {};
        config.inputs['popup'] = this;
        this._ngxDOMComponent = this._ngxDOMComponentContainer.create(config);
    };
    NgxPopupComponent.prototype._waitTransitionEnd = function () {
        var _this = this;
        return new Promise(function (resolve) {
            var transitionTime = _this._getTransitionTime(_this._element);
            if ((transitionTime === null) || (transitionTime > 10)) {
                setTimeout(resolve, transitionTime || 250);
                _this.addEventListener('transitionend', resolve, { once: true });
            }
            else {
                resolve();
            }
        });
    };
    NgxPopupComponent.prototype._getTransitionTime = function (element) {
        var computedStyle = window.getComputedStyle(element);
        if (computedStyle.transitionDuration) {
            var timeReg = new RegExp('([\\d\\.]+)((?:s)|(?:ms))', 'g');
            var timeMatch = timeReg.exec(computedStyle.transitionDuration);
            if (timeMatch !== null) {
                var time = parseFloat(timeMatch[1]);
                switch (timeMatch[2]) {
                    case 's':
                        return time * 1000;
                    case 'ms':
                        return time;
                }
            }
        }
        return null;
    };
    NgxPopupComponent.decorators = [
        { type: core_1.Component, args: [{
                    selector: 'ngx-popup',
                    template: "\n   <div class=\"content\">\n    <ng-template #contentContainer></ng-template>\n   </div>\n  "
                },] },
    ];
    /** @nocollapse */
    NgxPopupComponent.ctorParameters = function () { return [
        { type: ngx_dom_component_1.NgxDOMComponentService, },
        { type: core_1.ElementRef, },
    ]; };
    NgxPopupComponent.propDecorators = {
        "contentContainer": [{ type: core_1.ViewChild, args: ['contentContainer', { read: core_1.ViewContainerRef },] },],
        "onClickBackground": [{ type: core_1.HostListener, args: ['click', ['$event'],] },],
    };
    return NgxPopupComponent;
}());
exports.NgxPopupComponent = NgxPopupComponent;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NvbXBvbmVudHMvcG9wdXAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBRXVCO0FBQ3ZCLHVEQUFzRztBQUV0Ryw4REFBNkQ7QUFFN0QsSUFBWSxhQUtYO0FBTEQsV0FBWSxhQUFhO0lBQ3ZCLGtDQUFpQixDQUFBO0lBQ2pCLG9DQUFtQixDQUFBO0lBQ25CLGtDQUFpQixDQUFBO0lBQ2pCLG9DQUFtQixDQUFBO0dBSlQsYUFBYSxHQUFiLHFCQUFhLEtBQWIscUJBQWEsUUFLeEI7O0lBNkJDLDJCQUFvQixzQkFBOEMsRUFDdEQsT0FBbUI7UUFEWCwyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBRWhFLElBQUksQ0FBQyxpQkFBaUIsR0FBTSxJQUFJLENBQUM7UUFDakMsSUFBSSxDQUFDLG1CQUFtQixHQUFJLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsWUFBWSxHQUFXLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsYUFBYSxHQUFVLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUM7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDO0tBQ3ZDO0lBS0Qsc0JBQUksOENBQWU7UUFIbkI7O1dBRUc7Ozs7UUFDSDtZQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDO1NBQ3ZDOzs7T0FBQTtJQU1ELHNCQUFJLHNDQUFPO1FBSlg7OztXQUdHOzs7OztRQUNIO1lBQ0UsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7U0FDdEI7OztPQUFBO0lBRUQsc0JBQUksb0NBQUs7YUFBVDtZQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3BCOzs7T0FBQTtJQUdELHNCQUFJLHVDQUFRO2FBQVo7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M1JGLGdCQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLFdBQVc7b0JBQ3JCLFFBQVEsRUFBRSxnR0FJVDtpQkFDRjs7OztnQkFwQm1ELDBDQUFzQjtnQkFGaEMsaUJBQVU7OztxQ0F5QmpELGdCQUFTLFNBQUMsa0JBQWtCLEVBQUUsRUFBRSxJQUFJLEVBQUUsdUJBQWdCLEVBQUU7c0NBdU94RCxtQkFBWSxTQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQzs7NEJBalFuQzs7QUF3QmEsOENBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBDb21wb25lbnQsIFZpZXdDb250YWluZXJSZWYsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCwgSG9zdExpc3RlbmVyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5neERPTUNvbXBvbmVudCwgTmd4RE9NQ29tcG9uZW50Q29udGFpbmVyLCBOZ3hET01Db21wb25lbnRTZXJ2aWNlIH0gZnJvbSAnbmd4LWRvbS1jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBJUG9wdXBDb25maWcgfSBmcm9tICcuLi9zZXJ2aWNlcy9uZ3gtcG9wdXAuc2VydmljZSc7XHJcbmltcG9ydCB7IERlZmVycmVkUHJvbWlzZSB9IGZyb20gJy4uL2NsYXNzZXMvRGVmZXJyZWRQcm9taXNlJztcclxuXHJcbmV4cG9ydCBlbnVtIE5neFBvcHVwU3RhdGUge1xyXG4gIENMT1NFRCA9ICdjbG9zZWQnLFxyXG4gIENMT1NJTkcgPSAnY2xvc2luZycsXHJcbiAgT1BFTkVEID0gJ29wZW5lZCcsXHJcbiAgT1BFTklORyA9ICdvcGVuaW5nJ1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBUTmd4UG9wdXBTdGF0ZSA9ICdjbG9zZWQnIHwgJ2Nsb3NpbmcnIHwgJ29wZW5lZCcgfCAnb3BlbmluZycgfCBOZ3hQb3B1cFN0YXRlO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICduZ3gtcG9wdXAnLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgIDxkaXYgY2xhc3M9XCJjb250ZW50XCI+XHJcbiAgICA8bmctdGVtcGxhdGUgI2NvbnRlbnRDb250YWluZXI+PC9uZy10ZW1wbGF0ZT5cclxuICAgPC9kaXY+XHJcbiAgYFxyXG59KVxyXG5leHBvcnQgY2xhc3MgTmd4UG9wdXBDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgQFZpZXdDaGlsZCgnY29udGVudENvbnRhaW5lcicsIHsgcmVhZDogVmlld0NvbnRhaW5lclJlZiB9KVxyXG4gIHByb3RlY3RlZCBjb250ZW50Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmO1xyXG5cclxuICBwcm90ZWN0ZWQgX2Nsb3NhYmxlTGlzdGVuZXI6ICgoKSA9PiB2b2lkKSB8IG51bGw7XHJcbiAgcHJvdGVjdGVkIF9iYWNrZ3JvdW5kQ2xvc2FibGU6IGJvb2xlYW47XHJcblxyXG4gIHByb3RlY3RlZCBfbmd4RE9NQ29tcG9uZW50Q29udGFpbmVyOiBOZ3hET01Db21wb25lbnRDb250YWluZXI7XHJcbiAgcHJvdGVjdGVkIF9uZ3hET01Db21wb25lbnQ6IE5neERPTUNvbXBvbmVudDtcclxuXHJcbiAgcHJvdGVjdGVkIF9vcGVuUHJvbWlzZTogRGVmZXJyZWRQcm9taXNlPHZvaWQ+IHwgbnVsbDtcclxuICBwcm90ZWN0ZWQgX2Nsb3NlUHJvbWlzZTogRGVmZXJyZWRQcm9taXNlPHZvaWQ+IHwgbnVsbDtcclxuXHJcbiAgcHJvdGVjdGVkIF9zdGF0ZTogVE5neFBvcHVwU3RhdGU7XHJcbiAgcHJvdGVjdGVkIF9lbGVtZW50OiBIVE1MRWxlbWVudDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZ3hET01Db21wb25lbnRTZXJ2aWNlOiBOZ3hET01Db21wb25lbnRTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgIGVsZW1lbnQ6IEVsZW1lbnRSZWYpIHtcclxuICAgIHRoaXMuX2Nsb3NhYmxlTGlzdGVuZXIgICAgPSBudWxsO1xyXG4gICAgdGhpcy5fYmFja2dyb3VuZENsb3NhYmxlICA9IHRydWU7XHJcbiAgICB0aGlzLl9vcGVuUHJvbWlzZSAgICAgICAgID0gbnVsbDtcclxuICAgIHRoaXMuX2Nsb3NlUHJvbWlzZSAgICAgICAgPSBudWxsO1xyXG4gICAgdGhpcy5fc3RhdGUgPSBOZ3hQb3B1cFN0YXRlLkNMT1NFRDtcclxuICAgIHRoaXMuX2VsZW1lbnQgPSBlbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBpbnN0YW5jZSBvZiB0aGUgaW5qZWN0ZWQgY29tcG9uZW50LlxyXG4gICAqL1xyXG4gIGdldCBjb250ZW50SW5zdGFuY2UoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9uZ3hET01Db21wb25lbnQuaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBET00gZWxlbWVudCBvZiB0aGUgcG9wdXBcclxuICAgKiBAcmV0dXJucyB7SFRNTEVsZW1lbnR9XHJcbiAgICovXHJcbiAgZ2V0IGVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xyXG4gICAgcmV0dXJuIHRoaXMuX2VsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICBnZXQgc3RhdGUoKTogVE5neFBvcHVwU3RhdGUge1xyXG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldCBjbG9zYWJsZSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLl9jbG9zYWJsZUxpc3RlbmVyID09PSBudWxsO1xyXG4gIH1cclxuXHJcbiAgc2V0IGNsb3NhYmxlKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICB2YWx1ZSA9IEJvb2xlYW4odmFsdWUpO1xyXG4gICAgY29uc3QgY2xvc2FibGU6IGJvb2xlYW4gPSAodGhpcy5fY2xvc2FibGVMaXN0ZW5lciA9PT0gbnVsbCk7XHJcbiAgICBpZiAodmFsdWUgIT09IGNsb3NhYmxlKSB7XHJcbiAgICAgIGlmIChjbG9zYWJsZSkgeyAvLyBzd2l0Y2ggZnJvbSB0cnVlIHRvIGZhbHNlXHJcbiAgICAgICAgY29uc3QgbGlzdGVuZXIgPSAoZXZlbnQ6IEV2ZW50KSA9PiB7XHJcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcignYmVmb3JlY2xvc2UnLCBsaXN0ZW5lcik7XHJcbiAgICAgICAgdGhpcy5fY2xvc2FibGVMaXN0ZW5lciA9ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmVmb3JlY2xvc2UnLCBsaXN0ZW5lcik7XHJcbiAgICAgICAgICB0aGlzLl9jbG9zYWJsZUxpc3RlbmVyID0gbnVsbDtcclxuICAgICAgICB9O1xyXG4gICAgICB9IGVsc2UgeyAvLyBzd2l0Y2ggZnJvbSBmYWxzZSB0byB0cnVlXHJcbiAgICAgICAgdGhpcy5fY2xvc2FibGVMaXN0ZW5lcigpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXQgYmFja2dyb3VuZENsb3NhYmxlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2JhY2tncm91bmRDbG9zYWJsZTtcclxuICB9XHJcblxyXG4gIHNldCBiYWNrZ3JvdW5kQ2xvc2FibGUodmFsdWU6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuX2JhY2tncm91bmRDbG9zYWJsZSA9IEJvb2xlYW4odmFsdWUpO1xyXG4gIH1cclxuXHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIHRoaXMuX25neERPTUNvbXBvbmVudENvbnRhaW5lciA9IHRoaXMubmd4RE9NQ29tcG9uZW50U2VydmljZS5jcmVhdGVDb250YWluZXIodGhpcy5jb250ZW50Q29udGFpbmVyKTtcclxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IC8vIGFsbG93cyBjc3MgdG8gYXBwbHkgd2l0aG91dCB0aGUgY2xhc3MgJ29wZW4nXHJcbiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3JlYWR5JykpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGZvbGxvd2luZyBldmVudHMgYXJlIGF2YWlsYWJsZVxyXG4gICAqXHJcbiAgICogLSBvcGVuIDogYWZ0ZXIgdGhlIHBvcHVwIGlzIG9wZW5lZCAoaW5jbHVkaW5nIHRyYW5zaXRpb24gb3Igbm90LCBhY2NvcmRpbmcgdG8gJ3dhaXRUcmFuc2l0aW9uRW5kJykuXHJcbiAgICogLSBjbG9zZSA6IGFmdGVyIHRoZSBwb3B1cCBpcyBjbG9zZWQgKGluY2x1ZGluZyB0cmFuc2l0aW9uIG9yIG5vdCwgYWNjb3JkaW5nIHRvICd3YWl0VHJhbnNpdGlvbkVuZCcpLlxyXG4gICAqIC0gYmVmb3JlY2xvc2UgOiB3aGVuIHRoZSBjbG9zZSBtZXRob2QgaXMgY2FsbGVkLiBVc2UgZXZlbnQucHJldmVudERlZmF1bHQoKSB0byBjYW5jZWwgY2xvc2UuXHJcbiAgICogLSBjYW5jZWxvcGVuIDogd2hlbiBhbiBvcGVuIGlzIGNhbmNlbGxlZCAoZXg6IHdoaWxlIGFuaW1hdGluZywgdGhlIHBvcHVwIGlzIGluIGEgJ29wZW5pbmcnIHN0YXRlLFxyXG4gICAqICAgICAgICAgICAgICAgIGlmIHlvdSBjYWxsIGNsb3NlIGJlZm9yZSBhbmltYXRpb24gaXMgY29tcGxldGUsIGl0IGNhbmNlbHMgdGhlIG9wZW4pLlxyXG4gICAqXHJcbiAgICogQWxsIG9mIHRoZW0gYXJlIEN1c3RvbUV2ZW50LCB3aXRoIGEgZGV0YWlsIHByb3BlcnR5IHRoYXQgeW91IGNhbiBzZXQgd2hlbiBjYWxsaW5nIG9wZW4gb3IgY2xvc2UuXHJcbiAgICovXHJcblxyXG4gIGFkZEV2ZW50TGlzdGVuZXIodHlwZTogc3RyaW5nLCBsaXN0ZW5lcj86IEV2ZW50TGlzdGVuZXJPckV2ZW50TGlzdGVuZXJPYmplY3QsIHVzZUNhcHR1cmU/OiBhbnkpOiB2b2lkIHtcclxuICAgIHJldHVybiB0aGlzLl9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIHVzZUNhcHR1cmUpO1xyXG4gIH1cclxuXHJcbiAgZGlzcGF0Y2hFdmVudChldmVudDogRXZlbnQpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLl9lbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlOiBzdHJpbmcsIGxpc3RlbmVyPzogRXZlbnRMaXN0ZW5lck9yRXZlbnRMaXN0ZW5lck9iamVjdCwgdXNlQ2FwdHVyZT86IGFueSk6IHZvaWQge1xyXG4gICAgcmV0dXJuIHRoaXMuX2VsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lciwgdXNlQ2FwdHVyZSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgb3Blbihjb25maWc6IElQb3B1cENvbmZpZywgd2FpdFRyYW5zaXRpb25FbmQ6IGJvb2xlYW4gPSB0cnVlLCBkZXRhaWw/OiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICh0aGlzLl9vcGVuUHJvbWlzZSA9PT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9vcGVuUHJvbWlzZSA9IG5ldyBEZWZlcnJlZFByb21pc2U8dm9pZD4oKCkgPT4ge1xyXG4gICAgICAgIHN3aXRjaCAodGhpcy5fc3RhdGUpIHtcclxuICAgICAgICAgIGNhc2UgTmd4UG9wdXBTdGF0ZS5DTE9TRUQ6XHJcbiAgICAgICAgICBjYXNlIE5neFBvcHVwU3RhdGUuQ0xPU0lORzpcclxuICAgICAgICAgICAgY29uc3QgYmVmb3JlT3BlblByZXZlbnRlZDogYm9vbGVhbiA9ICF0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdiZWZvcmVvcGVuJywge1xyXG4gICAgICAgICAgICAgIGRldGFpbDogZGV0YWlsLFxyXG4gICAgICAgICAgICAgIGJ1YmJsZXM6IGZhbHNlLFxyXG4gICAgICAgICAgICAgIGNhbmNlbGFibGU6IHRydWVcclxuICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGJlZm9yZU9wZW5QcmV2ZW50ZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLl9vcGVuUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGBPcGVuIHByZXZlbnRlZGApKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBpZiAodGhpcy5fc3RhdGUgPT09IE5neFBvcHVwU3RhdGUuQ0xPU0lORykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnY2FuY2VsY2xvc2UnKSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZVByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgQ2xvc2UgY2FuY2VsbGVkYCkpO1xyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgdGhpcy5fc3RhdGUgPSBOZ3hQb3B1cFN0YXRlLk9QRU5JTkc7XHJcbiAgICAgICAgICAgICAgdGhpcy5fYnVpbGQoY29uZmlnKTtcclxuXHJcbiAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsgLy8gYWxsb3dzIGNvbnRlbnQgdG8gYmUgcmVuZGVyZWQgYmVmb3JlIGFkZGluZyAnb3BlbidcclxuICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnQuY2xhc3NMaXN0LmFkZCgnb3BlbicpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHdhaXRUcmFuc2l0aW9uRW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRUcmFuc2l0aW9uRW5kKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX29wZW5Qcm9taXNlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcGVuUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuX29wZW5Qcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRoaXMuX29wZW5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoYFBvcHVwIG5vdCBjbG9zZWRgKSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLl9vcGVuUHJvbWlzZVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX3N0YXRlID0gTmd4UG9wdXBTdGF0ZS5PUEVORUQ7XHJcbiAgICAgICAgICB0aGlzLl9vcGVuUHJvbWlzZSA9IG51bGw7XHJcbiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdvcGVuJywge1xyXG4gICAgICAgICAgICBkZXRhaWw6IGRldGFpbFxyXG4gICAgICAgICAgfSkpO1xyXG4gICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX29wZW5Qcm9taXNlID0gbnVsbDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5fb3BlblByb21pc2UucHJvbWlzZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsb3NlIHRoZSBwb3B1cC5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB3YWl0VHJhbnNpdGlvbkVuZFxyXG4gICAqIEBwYXJhbSBkZXRhaWxcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gLSBwcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZFxyXG4gICAqL1xyXG4gIGNsb3NlKHdhaXRUcmFuc2l0aW9uRW5kOiBib29sZWFuID0gdHJ1ZSwgZGV0YWlsPzogYW55KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAodGhpcy5fY2xvc2VQcm9taXNlID09PSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX2Nsb3NlUHJvbWlzZSA9IG5ldyBEZWZlcnJlZFByb21pc2U8dm9pZD4oKCkgPT4ge1xyXG4gICAgICAgIHN3aXRjaCAodGhpcy5fc3RhdGUpIHtcclxuICAgICAgICAgIGNhc2UgTmd4UG9wdXBTdGF0ZS5PUEVORUQ6XHJcbiAgICAgICAgICBjYXNlIE5neFBvcHVwU3RhdGUuT1BFTklORzpcclxuICAgICAgICAgICAgY29uc3QgYmVmb3JlQ2xvc2VQcmV2ZW50ZWQ6IGJvb2xlYW4gPSAhdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnYmVmb3JlY2xvc2UnLCB7XHJcbiAgICAgICAgICAgICAgZGV0YWlsOiBkZXRhaWwsXHJcbiAgICAgICAgICAgICAgYnViYmxlczogZmFsc2UsXHJcbiAgICAgICAgICAgICAgY2FuY2VsYWJsZTogdHJ1ZVxyXG4gICAgICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoYmVmb3JlQ2xvc2VQcmV2ZW50ZWQpIHtcclxuICAgICAgICAgICAgICB0aGlzLl9jbG9zZVByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgQ2xvc2UgcHJldmVudGVkYCkpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gTmd4UG9wdXBTdGF0ZS5PUEVOSU5HKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdjYW5jZWxvcGVuJykpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fb3BlblByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgT3BlbiBjYW5jZWxsZWRgKSk7XHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICB0aGlzLl9zdGF0ZSA9IE5neFBvcHVwU3RhdGUuQ0xPU0lORztcclxuICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ29wZW4nKTtcclxuICAgICAgICAgICAgICBpZiAod2FpdFRyYW5zaXRpb25FbmQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3dhaXRUcmFuc2l0aW9uRW5kKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jbG9zZVByb21pc2UgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZVByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VQcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aGlzLl9jbG9zZVByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgUG9wdXAgbm90IG9wZW5lZGApKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMuX2Nsb3NlUHJvbWlzZVxyXG4gICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX3N0YXRlID0gTmd4UG9wdXBTdGF0ZS5DTE9TRUQ7XHJcbiAgICAgICAgICB0aGlzLl9jbG9zZVByb21pc2UgPSBudWxsO1xyXG4gICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnY2xvc2UnLCB7XHJcbiAgICAgICAgICAgIGRldGFpbDogZGV0YWlsXHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5fY2xvc2VQcm9taXNlID0gbnVsbDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5fY2xvc2VQcm9taXNlLnByb21pc2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snLCBbJyRldmVudCddKVxyXG4gIG9uQ2xpY2tCYWNrZ3JvdW5kKGV2ZW50OiBhbnkpIHtcclxuICAgIGlmICh0aGlzLl9iYWNrZ3JvdW5kQ2xvc2FibGUgJiYgKGV2ZW50LnRhcmdldCA9PT0gdGhpcy5fZWxlbWVudCkpIHtcclxuICAgICAgdGhpcy5jbG9zZSh0cnVlLCBldmVudCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgcHJpdmF0ZSBfYnVpbGQoY29uZmlnOiBJUG9wdXBDb25maWcpIHtcclxuICAgIGNvbmZpZy5pbnB1dHMgPSBjb25maWcuaW5wdXRzIHx8IHt9O1xyXG4gICAgY29uZmlnLmlucHV0c1sncG9wdXAnXSA9IHRoaXM7XHJcbiAgICB0aGlzLl9uZ3hET01Db21wb25lbnQgPSB0aGlzLl9uZ3hET01Db21wb25lbnRDb250YWluZXIuY3JlYXRlKGNvbmZpZyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF93YWl0VHJhbnNpdGlvbkVuZCgpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgdHJhbnNpdGlvblRpbWU6IG51bWJlciA9IHRoaXMuX2dldFRyYW5zaXRpb25UaW1lKHRoaXMuX2VsZW1lbnQpO1xyXG4gICAgICBpZiAoKHRyYW5zaXRpb25UaW1lID09PSBudWxsKSB8fCAodHJhbnNpdGlvblRpbWUgPiAxMCkpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIHRyYW5zaXRpb25UaW1lIHx8IDI1MCk7XHJcbiAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgcmVzb2x2ZSwgeyBvbmNlOiB0cnVlIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9nZXRUcmFuc2l0aW9uVGltZShlbGVtZW50OiBIVE1MRWxlbWVudCk6IG51bWJlciB7XHJcbiAgICBjb25zdCBjb21wdXRlZFN0eWxlOiBDU1NTdHlsZURlY2xhcmF0aW9uID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCk7XHJcbiAgICBpZiAoY29tcHV0ZWRTdHlsZS50cmFuc2l0aW9uRHVyYXRpb24pIHtcclxuICAgICAgY29uc3QgdGltZVJlZzogUmVnRXhwID0gbmV3IFJlZ0V4cCgnKFtcXFxcZFxcXFwuXSspKCg/OnMpfCg/Om1zKSknLCAnZycpO1xyXG4gICAgICBjb25zdCB0aW1lTWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGwgPSB0aW1lUmVnLmV4ZWMoY29tcHV0ZWRTdHlsZS50cmFuc2l0aW9uRHVyYXRpb24pO1xyXG4gICAgICBpZiAodGltZU1hdGNoICE9PSBudWxsKSB7XHJcbiAgICAgICAgY29uc3QgdGltZTogbnVtYmVyID0gcGFyc2VGbG9hdCh0aW1lTWF0Y2hbMV0pO1xyXG4gICAgICAgIHN3aXRjaCAodGltZU1hdGNoWzJdKSB7XHJcbiAgICAgICAgICBjYXNlICdzJzpcclxuICAgICAgICAgICAgcmV0dXJuIHRpbWUgKiAxMDAwO1xyXG4gICAgICAgICAgY2FzZSAnbXMnOlxyXG4gICAgICAgICAgICByZXR1cm4gdGltZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxufSJdfQ==